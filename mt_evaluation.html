<!DOCTYPE HTML>
<!--
	Hyperspace by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<!--Header-->
<head>
    <meta charset="UTF-8">
    <title>Machine translation human assessment</title>
    <link rel="shortcut icon" href="mt-evaluation-web/images/logoPRHLT.png">
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>


    <!-- core CSS -->
    <link rel="stylesheet" href="mt-evaluation-web/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="mt-evaluation-web/assets/css/bootstrap-slider.css">

    <link rel="stylesheet" href="mt-evaluation-web/assets/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="mt-evaluation-web/assets/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="mt-evaluation-web/assets/css/ie8.css"/><![endif]-->

    <!-- Scripts -->
    <script src="mt-evaluation-web/assets/js/jquery.min.js"></script>
    <script src="mt-evaluation-web/assets/js/jquery.scrollex.min.js"></script>
    <script src="mt-evaluation-web/assets/js/jquery.scrolly.min.js"></script>
    <script src="mt-evaluation-web/assets/js/skel.min.js"></script>
    <script src="mt-evaluation-web/assets/js/util.js"></script>
    <script src="mt-evaluation-web/assets/js/ie/html5shiv.js"></script>
    <script src="mt-evaluation-web/assets/js/StreamSaver.js"></script>
    <!-- load before streams polyfill to detect support -->
    <script src="https://cdn.rawgit.com/creatorrr/web-streams-polyfill/master/dist/polyfill.min.js"></script>
    <script type="module">
        // it also support commonJs and amd
        import {createWriteStream, supported, version} from 'StreamSaver'
        const {createWriteStream, supported, version} = require('StreamSaver');
        const {createWriteStream, supported, version} = window.streamSaver;
        alert(supported)
    </script>

</head>
<body>

<!-- Sidebar -->
<section id="sidebar">

    <div class="inner">
        <nav>
            <ul>
                <li><a href="#intro">Welcome</a></li>
                <!--<li><a href="#mt-assessment">Translation assessment</a></li>-->
                <li><a href="#direct-assessment">Direct assessment</a></li>
                <li><a href="#data-info">Data information</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </nav>
    </div>
</section>

<!-- Wrapper -->
<div id="wrapper">

    <section id="intro" class="wrapper style1 fullscreen fade-up">
        <div class="inner">
            <h1>Machine translation human assessment</h1>
            <p> Website for performing human evaluation of machine translation (MT) outputs. </p>

            <p class="alert alert-danger"
               id="filesloaded" style="display:none;">Please, load two block files.</p>


            <p> Select a block with MT translations:
                <input type="file" id="transFile"></p>
            <p> Select a block with references:
                <input type="file" id="refsFile"></p>


            <div style='padding:15px'>
                <ul class="actions">
                    <!--<li><a href="#mt-assessment" class="button scrolly">Translation assessment</a></li>-->
                    <!--<li><a href="#direct-assessment" class="button scrolly">Direct assessment</a></li>-->
                    <li><a href="#data-info" class="button scrolly">Data information</a></li>
                    <li><a href="#contact" class="button scrolly">Contact</a></li>
                </ul>
            </div>
        </div>
    </section>

    <section id="direct-assessment" class="wrapper style1 fullscreen fade-up">
        <div class="inner">
            <h1>Direct assessment</h1>
            <div style='padding:15px'></div>
            <div class="inner">
                <p> Please, evaluate how adequately the second sentence expresses the meaning of the first one.</p>
                <textarea name="da_reference" id="da-reference" readonly> Sample sentence in English... </textarea>&nbsp;
                <textarea name="da_translation" id="da-translation"
                          readonly> Frase de ejemplo en ingles (del sistema) </textarea>&nbsp;
                <div style='padding:5px'></div>
                <form id='validate-da-assessment' onsubmit='validate_da_assessment(); return false;'>
                    <input id="da-assessment-slider" type="text"/>
                    <p> How accurately does the above candidate text convey the original semantics of the reference
                        text? <br>
                        Slider ranges from Not at all (left) to Perfectly (right).</p>
                    <div class="container">
                    </div>

                    <table style="width:80%">
                        <tr>
                            <th>
                                <div style="float: left;">
                                    <button class="button scrolly" onclick="reset_da()">Reset</button>
                                    <button class="button scrolly" onclick="previous_da()">Previous</button>

                                </div>
                            </th>
                            </th>
                            <th>
                                <div style="float: right;">
                                    <button id="submit-button" type="submit" class="button scrolly"> - </button>
                                </div>
                            </th>
                        </tr>
                    </table>

                </form>
            </div>
        </div>
    </section>



    <section id="data-info" class="wrapper style3 fade-up">
        <div class="inner">
            <h1>Data information</h1>
            This website performs the Direct Assessment (DA) protocol for evaluating translation hypotheses.<br>
            You should provide two files, one with machine translation hypotheses and another one with the corresponding reference translations.<br>
            Each file must contain a line per sentence, with the following format:<br><br>

            <code>#block \t sys \t domain \t #sentence \t sentence</code>&nbsp;<br><br>

            were:
            <ul style="list-style-type: none">
                <li><code>#block</code> &rarr;  block identifier. </li>
                <li><code>\t</code> &rarr;  tabular symbol.</li>
                <li><code>sys</code> &rarr; system identifier.</li>
                <li><code>domain</code> &rarr; domain identifier.</li>
                <li><code>#sentence</code> &rarr;  sentence identifier.</li>
                <li><code>sentence</code> &rarr; sentence to be displayed.</li>
            </ul>

            This website has been developed for and used in the following work:

                <p>
                    <a href="mt-evaluation-web/resources/eamt18.pdf"
                       class="icon fa-file-pdf-o fa-2x" style="font-size:25px"> Are Automatic Metrics Robust and Reliable in Specific Machine Translation Tasks?</a><br/>
                    Mara Chinea-Rios, Álvaro Peris, and Francisco Casacuberta. <br/>
                    In <em> Proceedings of the 21st Annual Conference of the European Association for Machine Translation, pp. 89-98</em>, 2018.

            <ul class="actions">
                <li><a href="mt-evaluation-web/resources/eamt18.pdf" class="button">Paper</a></li>
                <li><a href="mt-evaluation-web/resources/eamt18_data.zip" class="button">Dataset</a></li>
            </ul>
                </p>


        </div>
    </section>



    <!-- contact -->
    <section id="contact" class="wrapper style1 fade-up">
        <div class="inner">
            <h1>Contact: Álvaro Peris</h1>
            <a class="fa fa-mail-forward fa-2x"> lvapeab-at-gmail-dot-com</a>
            <br>
            <br>

           <h3>The source code of this website is publicly available at <a href="https://github.com/lvapeab/lvapeab.github.io/tree/master/mt-evaluation-web">Github</a>  </h3>


            <ul class="icons">
                <li><a href="https://www.prhlt.upv.es/u/lvapeab" class="fa-globe fa-3x"><span class="label">PRHLT</span></a>
                </li>
                <li><a href="https://github.com/lvapeab" class="fa-github fa-3x"><span class="label">GitHub</span></a>
                </li>
                <li><a href="https://scholar.google.es/citations?user=oaTV3OoAAAAJ&hl=es&oi=ao" class="fa-google fa-3x"><span
                        class="label">Google Scholar</span></a></li>
                <li><a href="http://es.linkedin.com/in/lvapeab" class="fa-linkedin fa-3x"><span
                        class="label">LinkedIn</span></a></li>
            </ul>
        </div>
    </section>

    <!-- Footer -->
    <footer id="footer" class="wrapper style1-alt">
        <div class="inner">
            <ul class="menu">
                <li>&copy; Álvaro Peris. All rights reserved.</li>
                <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
            </ul>
        </div>
    </footer>
</div>

<script type='text/javascript' src="mt-evaluation-web/assets/js/bootstrap-slider.min.js"></script>
<script type='text/javascript' src="mt-evaluation-web/assets/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type='text/javascript'>

    var trans_reader, refs_reader, source_reader; // File reader
    var loaded_trans_block, loaded_ref_block = 0; // Flags for having loaded a file

    var reference_block_ids = []; // Array with DA evaluations
    var reference_system_ids = []; // Array with DA evaluations
    var reference_domain_ids = []; // Array with DA evaluations
    var reference_sentence_id = [];
    var reference_sentences = []; // Array with DA evaluations

    var hypotheses_block_ids = [];
    var hypotheses_system_ids = [];
    var hypotheses_domain_ids = [];
    var hypotheses_sentence_id = [];
    var hypotheses_sentences = [];

    var evaluations_da = []; // Array with DA evaluations
    var times_evaluations_da = []; // Array with DA evaluation times
    var start;
    var currentSent;
    var totalSents;

    $(document).ready(function () {
        $("#mt-assessment-slider").slider({
            ticks: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
            ticks_labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
            tooltip: 'always'
        });

        // Configuration of the slider from the direct assessment section
        $("#da-assessment-slider").slider({
            ticks: [0, 25, 50, 75, 100],
            ticks_labels: ['|', '|', '|', '|', '|'],
//            tooltip: 'hide',
            value: 50
        });
    });


    window.onload = function () {
        // Load files: One with reference sentences and another one with MT hypotheses.
        var reffileInput = document.getElementById('refsFile');
        var transfileInput = document.getElementById('transFile');

        // Reference file reader
        reffileInput.addEventListener('change', function (e) {
            var file = reffileInput.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                // Read file and split by line
                refs_reader = reader.result.split("\n");
                // Count sentences
                evaluations_da.length = refs_reader.length;
                times_evaluations_da.length = refs_reader.length;
                reference_block_ids.length = refs_reader.length;
                reference_system_ids.length = refs_reader.length;
                reference_domain_ids.length = refs_reader.length;
                reference_sentences.length = refs_reader.length;
                totalSents = reference_sentences.length - 1;
                for (var i = 0; i < refs_reader.length; i++) {
                    ref_line = refs_reader[i].split("\t");
                    reference_block_ids[i] = ref_line[0];
                    reference_system_ids[i] = ref_line[1];
                    reference_domain_ids[i] = ref_line[2];
                    reference_sentence_id[i] = ref_line[3];
                    reference_sentences[i] = ref_line[4];
                }

                $('#totalSent').text(evaluations_da.length - 1);
                loaded_ref_block = 1;

                if (loaded_trans_block == 1) { // If all files are loaded, go to the evaluation section
                    window.location = '#direct-assessment';
                    loadNewDApair(1);

                }
            };
            reader.readAsText(file);
        });

        // Hypotheses file reader.
        // Format: block_id \t system_id \t domain_id \t sentence_id \t sentence
        transfileInput.addEventListener('change', function (e) {
            var file = transfileInput.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                // Read file and split by line
                trans_reader = reader.result.split("\n");
                // Count sentences
                evaluations_da.length = trans_reader.length;
                times_evaluations_da.length = trans_reader.length;
                hypotheses_block_ids.length = trans_reader.length;
                hypotheses_system_ids.length = trans_reader.length;
                hypotheses_domain_ids.length = trans_reader.length;
                hypotheses_sentences.length = trans_reader.length;
                totalSents = hypotheses_sentences.length - 1;
                for (var i = 0; i < trans_reader.length; i++) {
                    trans_line = trans_reader[i].split("\t");
                    hypotheses_block_ids[i] = trans_line[0];
                    hypotheses_system_ids[i] = trans_line[1];
                    hypotheses_domain_ids[i] = trans_line[2];
                    hypotheses_sentence_id[i] = trans_line[3];
                    hypotheses_sentences[i] = trans_line[4];
                }
                $('#totalSent').text(evaluations_da.length - 1);
                loaded_trans_block = 1;
                if (loaded_ref_block == 1) { // If all files are loaded, go to the evaluation section
                    window.location = '#direct-assessment';
                    loadNewDApair(1);

                }

            };

            reader.readAsText(file);
        });

    };

    // Loads a new direct assessment pair
    function loadNewDApair(sentence_idx) {
        document.getElementById('da-translation').innerHTML = hypotheses_sentences[sentence_idx - 1];
        document.getElementById('da-reference').innerHTML = reference_sentences[sentence_idx - 1];
        currentSent = sentence_idx;
        start = Date.now();
        document.getElementById('submit-button').innerHTML = 'Submit (' + currentSent + '/' + totalSents + ')';

    }

    // Validates an evaluation in DA mode
    // Loads the next DA pair (or finishes the process)
    function validate_da_assessment() {

        // If we haven't loaded all files, raise error and go to the file loading section.
        if (loaded_trans_block == 0 || loaded_ref_block == 0) {
            window.location = '#intro';
            var filesloaded = $('#filesloaded');
            filesloaded.show();
            filesloaded.fadeOut(10000);
            return null;
        }

        // Get the id of the current sentence and its assessment
        var assessment = document.getElementById('da-assessment-slider').value;
        var id_assessment = currentSent; //document.getElementById('currentSent').text;

        // Store the assessment in the evaluations array
        evaluations_da[id_assessment - 1] = assessment;

        times_evaluations_da[id_assessment - 1] = Date.now() - start;
        start = Date.now();
        // Next sentence
        var next_id = parseInt(id_assessment, 10) + 1;

        if (next_id + 1 == totalSents) { // Are we in the last sample? -> 'Finish' button
            document.getElementById('submit-button').innerHTML = 'Finish';
        }
        else { // We still have samples to evaluate? -> 'Submit' button
            document.getElementById('submit-button').innerHTML = 'Submit (' + currentSent + '/' + totalSents + ')';
        }
        // If all samples are evaluated, finish the experiment
        if (next_id >= evaluations_da.length) {
            finish_experiment();
        }
        else { // Retrieve the next sample
            loadNewDApair(next_id);
        }
        return next_id;

    }
    function reset_da() { // Reset the DA process

        //document.getElementById('currentSent').innerHTML = '0';
        currentSent = 0;
        evaluations_da = [];
        evaluations_da.length = trans_reader.length;

        times_evaluations_da = [];
        times_evaluations_da.length = trans_reader.length;
        loadNewDApair(0);
    }

    function previous_da() { // Reset the DA process
        // Get the id of the current sentence and its assessment
        var id = currentSent - 1; //parseInt(document.getElementById('currentSent').text, 10) - 1;
        if (id > 0) {
            loadNewDApair(id - 1);
        }
        else {
            loadNewDApair(0);
        }
    }

    function finish_experiment() { // Final protocol. We should store the user's evaluations.
        var evaluations_string = "";
        for (var i = 0; i < trans_reader.length - 1; i++) {
            evaluations_string +=
                    hypotheses_block_ids[i] + "\t" +
                    hypotheses_system_ids[i] + "\t" +
                    hypotheses_domain_ids[i] + "\t" +
                    hypotheses_sentence_id[i] + "\t" +
                    hypotheses_sentences[i] + "\t" +
                    "Evaluation\t" +
                    evaluations_da[i] + "\t" +
                    "Time\t" +
                    times_evaluations_da[i] + "\n";
        }

        var fullPath = document.getElementById('transFile').value;
        if (fullPath) {
            var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
            var transFile_name = fullPath.substring(startIndex);
            if (transFile_name.indexOf('\\') === 0 || transFile_name.indexOf('/') === 0) {
                transFile_name = transFile_name.substring(1);
            }
        }
        FileSave(evaluations_string, transFile_name + '_evaluation.sav');
        alert("Thank you!");
    }
    function destroyClickedElement(event) {
        document.body.removeChild(event.target);
    }

    function FileSave(sourceText, fileIdentity) {
        var textToSaveAsBlob = new Blob([sourceText], {type: "text/plain"});
        var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
        var fileNameToSaveAs = fileIdentity;

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        downloadLink.href = textToSaveAsURL;
        downloadLink.onclick = destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);

        downloadLink.click();
    }

</script>

</body>

<!--[if lte IE 8]>
<script src="mt-evaluation-web/assets/js/ie/respond.min.js"></script><![endif]-->
<script src="mt-evaluation-web/assets/js/main.js"></script>
</html>